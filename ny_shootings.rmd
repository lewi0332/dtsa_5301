---
title: "NY Shooting Incidents (Historical)"
author: "Derrick Lewis"
date: "2025-11-05"
output:
  html_document:
    code_folding: hide
---

```{r install_packages, include=FALSE}

## Uncomment the following to install any additional packages
# install.packages('details')
# install.packages('pander')
# install.packages('plotly')
# install.packages('kableExtra')
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse, quietly = TRUE, warn.conflicts = FALSE)
library(lubridate)
library(ggplot2)
library(details)
library(pander)
library(plotly)
library(kableExtra)
```

---

# Introduction 

In this document we will examine the open dataset from [Data.gov](https://catalog.data.gov/dataset) regarding NYC Shootings

This is a part of DTSA - 5301 "Data Science as a Field" coursework through the [University of Colorado](https://www.colorado.edu/program/data-science/coursera/curriculum/dtsa5301). 

---

## Setup and Data Collection

First we will read in the NYPD_Shooting_Incident_Data__Historic.csv from [Data.gov](https://catalog.data.gov/dataset/nypd-shooting-incident-data-historic). Then store this file locally for future use.


```{r data_read}
ny_shootings <- read_csv('https://data.cityofnewyork.us/api/views/833y-fsy8/rows.csv?accessType=DOWNLOAD', show_col_types = FALSE)
# if(!file.exists('data'))(dir.create('data'))
# write_csv(ny_shootings, "data/NYPD_Shooting_Incident_Data__Historic.csv")
# Comment out the above after the ititial read 
# ny_shootings <- read_csv('data/NYPD_Shooting_Incident_Data__Historic.csv', show_col_types = FALSE)
```
```{r summary, echo=FALSE, results='asis'}
cat("Number of rows:", nrow(ny_shootings), "\n\n")
cat("Number of columns:", ncol(ny_shootings), "\n\n")
cat("Date range:", min(ny_shootings$OCCUR_DATE), "to", max(ny_shootings$OCCUR_DATE), "\n")
```

### Data Summary: `NYPD_Shooting_Incident_Data__Historic`
```{r}
knitr::kable(slice_sample(ny_shootings, n = 5), caption = "NYC Shootings Data")
pander(summary(ny_shootings))
```

### Read in NY Population Data by Borough

In this next code cell, we will read in the population data for New York City by borough from a CSV file. This data will help us understand the population distribution across different boroughs, which can be useful for our analysis of shooting incidents.


```{r download_population}
boro_pop_raw <- read_csv('https://data.cityofnewyork.us/api/views/xywu-7bv9/rows.csv?accessType=DOWNLOAD', show_col_types = FALSE)
# write_csv(boro_pop_raw, "data/boro_pop_raw.csv")
#boro_pop_raw <- read_csv("data/boro_pop_raw.csv", show_col_types = FALSE)
```

### Tidy data of Population by Borough
 
The data available by official sources for the population of New York City is in a wide format. We will need to tidy this data into a long format to make it easier to work with in our analysis.

Additionally, the data is only availble by decade. This is accurate enough for our purposes, but we will do some data assumptions to fill in the gaps for years between the decades. In this case we treat the decade population as the population at the midpoint of the decade, and will use linear interpolation to estimate the population for the years in between.

```{r tidy_population}
boro_pop <- boro_pop_raw %>%
  select(Borough, `1950`, `1960`, `1970`, `1980`, `1990`, `2000`, `2010`, `2020`) %>%
  mutate(Borough = toupper(Borough)) # Convert Borough to uppercase

boro_pop_long <- boro_pop %>%
  pivot_longer(
    cols = -Borough, # All columns except Borough
    names_to = "Decade",
    values_to = "Population"
  ) %>%
  mutate(Decade = as.numeric(Decade)) %>% # Convert Decade to numeric
  rename(Year = Decade) # Rename Decade to Year

boro_pop_interpolated <- boro_pop_long %>%
  group_by(Borough) %>%
  complete(Year = full_seq(c(Year, max(Year) + 5), 1)) %>% # Create rows for every year
  arrange(Borough, Year) %>%
  mutate(Population = approx(Year, Population, Year, rule = 2)$y) %>% # Linear interpolation
  mutate(Population = lag(Population, n=5)) %>%
  ungroup()
  
pander(summary(boro_pop_interpolated))
# Print a sample of the interpolated data
knitr::kable(tail(boro_pop_interpolated), caption = "Boruough population interpolated from decade to years")
```


### Shootings per Borough per Year

In this section, we will analyze the number of murders per borough per year. This will help us understand the distribution of murders across different boroughs and how it changes over time.

First we will organize our data to group by `boro` and `year`. Here is the summary of our new table which shows the range and variance of the years and murder volume.

```{r data_shooting_per_year}
# Change "OCCUR_DATE" to an actual date datatype
ny_shootings <- ny_shootings %>%
  mutate(OCCUR_DATE = as.Date(OCCUR_DATE, format="%m/%d/%Y"))

# Extract the year from OCCUR_DATE and create a new column
ny_shootings <- ny_shootings %>%
  mutate(YEAR = lubridate::year(OCCUR_DATE))

# Group by borough and year and summarize only the murders
boro_deaths <- ny_shootings %>%
  group_by(BORO, YEAR) %>%
  summarize(murders = sum(STATISTICAL_MURDER_FLAG == TRUE, na.rm = TRUE), .groups = "drop") %>%
  ungroup()

pander(summary(boro_deaths))
```

### Convert to Per Capita View

In order to get a more accurate understanding of the murder rate across the 5 boroughs, we will join the shooting data with the population data to calculate the number of shootings per capita. This will allow us to compare the murder rates across boroughs more fairly, accounting for differences in population size.

```{r add_per_capita}
# Join with population to see a per capita View
boro_combined <- boro_deaths %>%
  left_join(boro_pop_interpolated, by = c("BORO" = "Borough", "YEAR" = "Year"))
boro_combined <- boro_combined %>%
  mutate(murders_per_capita = murders / Population)

pander(summary(boro_combined))
knitr::kable(slice_sample(boro_combined, n = 5), caption = "Adds per capita view")
```

---

## Visualizing per Capita Murders by Borough

```{r, fig.width=10, fig.height=6}

plot_ly(boro_combined, x = ~YEAR, y = ~murders_per_capita, color = ~BORO, 
        type = 'scatter', mode = 'lines') %>%
  layout(title = "Murders Over Time by Borough",
         xaxis = list(title = "Date"),
         yaxis = list(title = "Murders per Capita"))
```
We can see that for many Boroughs, the per capita shooting rates have been in decline since the data began being recorded. This suggests improvements in safety or changes in reporting over time. However, in the years of 2020 and 2021, there appears to be a significant increase in murder rates, which may be attributed to various social and economic factors during that period.

#### Key Findings:

**Pre-Pandemic Trends (2006-2019):**

- All five boroughs showed a general decline in per capita murder rates from the mid-2000s through 2019
- The Bronx and Brooklyn consistently had the highest murder rates per capita throughout this period
- Manhattan, Queens, and Staten Island maintained relatively lower and more stable rates

**COVID-19 Pandemic Impact (2020-2021):**

- Universal Spike: All five boroughs experienced a sharp increase in murder rates beginning in 2020
- Disproportionate Impact: The Bronx showed the most dramatic surge, with its per capita murder rate nearly doubling and reaching approximately 1.25 deaths per 10,000 residents (the highest point on the chart)
- Brooklyn: Also experienced a significant increase, though somewhat less pronounced than the Bronx
- Other Boroughs: Manhattan, Queens, and Staten Island saw increases as well, but their rates remained substantially lower than the Bronx and Brooklyn

**Post-Peak Trends (2022-2023):**

- The data suggests a beginning of decline from the 2020-2021 peaks across most boroughs
- However, rates remain elevated compared to 2019 pre-pandemic levels
- This pattern highlights how the social and economic disruptions of the COVID-19 pandemic exacerbated existing disparities in violence across NYC neighborhoods, with historically underserved communities in the Bronx and Brooklyn bearing the greatest burden.


---

## Visualizing Age and Race for Shooting Victims

In the next section we will look for patterns in the type of victims of shootings. 

First we will examine the age and race distribution of shooting victims

```{r age_dist}
ny_shootings %>%
  count(VIC_AGE_GROUP) %>%
  pander()
```
```{r race_dist}
ny_shootings %>%
  count(VIC_RACE) %>%
  pander()
```


There is one data point in the `VIC_AGE_GROUP` column that appears to be an outlier or error. The value of `1022` does not correspond to a valid age group and should be investigated or removed from the analysis.

```{r plot_victim_demographics, fig.width=10, fig.height=6}
vic_demo <- ny_shootings %>%
  filter(!VIC_AGE_GROUP %in% c("1022"))

vic_demo <- vic_demo %>%
  group_by(VIC_AGE_GROUP, VIC_SEX, VIC_RACE) %>%
  summarize(total_victims = n(), .groups = "drop")

# Create interactive plotly chart
plot_ly(vic_demo, x = ~VIC_AGE_GROUP, y = ~total_victims, color = ~VIC_RACE, 
        type = 'bar') %>%
  layout(title = "Victim Demographics in NYC Shootings",
         xaxis = list(title = "Age Group"),
         yaxis = list(title = "Number of Victims"),
         barmode = 'group',  # This creates the dodged/grouped bars
         legend = list(title = list(text = "Race")))
```


Shootings seem to disproportionately affect certain age groups and racial demographics. However, we are not comparing these demographics to overall population ratios at this point. In order to surface any hypothesis here we will also need to find the relative popultation means and distributions for these demographics.

---

## Build Logistic Regression Model

In the next Section we will build a logistic regression model to predict the likelihood of a murder based on various factors.

While this may produce insights, it is important to remember that we are only looking at the total count of shootings and looking for correlations where that shooting becomes a statistical murder.

#### Generalized Linear Model

Below we will build a generalized linear model to predict the likelihood of a murder based on severaly features in our dataset.  GLM's allow for modeling of binary outcomes and can provide insights into the factors that influence the probability of an event occurring.

```{r model}
# Create model specific data set
model_data <- ny_shootings %>%
  mutate(murder_flag = as.numeric(STATISTICAL_MURDER_FLAG)) %>%
  select(murder_flag, BORO, YEAR, PERP_AGE_GROUP, PERP_RACE, VIC_AGE_GROUP, VIC_RACE) %>%
  na.omit()

model <- glm(murder_flag ~ BORO + YEAR + PERP_AGE_GROUP + PERP_RACE + VIC_AGE_GROUP + VIC_RACE,
             data = model_data, family = "binomial")
```


```{r p_values}
# Example: Highlight significant p-values in the model summary
tidy_model <- broom::tidy(model)

# Create color vector that handles NA values
p_value_colors <- ifelse(is.na(tidy_model$p.value), "black",
                         ifelse(tidy_model$p.value < 0.05, "red", "black"))

tidy_model %>%
  knitr::kable(caption = "Model Summary", digits = 4) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(5, bold = TRUE, color = p_value_colors) %>%
  footnote(general = "Red values indicate statistical significance (p < 0.05)")
```

In the above output, we can look for features that have a significant impact on the likelihood of a murder given a shooting happened.

Important note is to look for the coefficients and their statistical significance to understand which factors are most influential.

### Interpreting Significant Predictors

The features highlighted in red show statistical significance (p < 0.05), meaning:

- **These factors have a reliable relationship with shooting lethality** that cannot be attributed to random variation
- **The model is confident** (>95%) that these variables genuinely influence whether a shooting becomes a murder
- Variables with **positive coefficients increase the odds** of a fatal outcome
- Variables with **negative coefficients decrease the odds** of a fatal outcome

For example:
- If `VIC_AGE_GROUP65+` has a positive coefficient and p < 0.05, we can conclude that **victims over 65 are significantly more likely to die from gunshot wounds** compared to the reference age group
- If `YEAR` has a negative coefficient and p < 0.05, it suggests that **shootings have become less lethal over time**, controlling for other factors

### Limitations of P-Values

While statistical significance indicates a relationship exists, it **does not tell us**:

1. **Causation**: Correlation â‰  causation. These factors may be correlated with lethality without directly causing it
2. **Practical Significance**: A statistically significant effect may be too small to matter in real-world terms
3. **Confounding Variables**: Other unmeasured factors may be the true drivers of the relationship
4. **Model Assumptions**: The conclusions depend on the model being correctly specified

**Example**: If victim race shows significance, this likely reflects systemic inequalities in access to emergency medical care, not inherent biological differences.

---

### Use Predictive Modeling

Below we will use our predictive model to visualize the prediction probability organized buy a specific feature. While this has _some_ interesting information, we must also recognize that this is only one feature of the data and there may be confounding variables to consider. 

```{r vic_plot, fig.width=10, fig.height=6}
model_data <- model_data %>%
  mutate(predicted_prob = predict(model, type = "response"))

model_data_filtered <- model_data %>%
  filter(!VIC_AGE_GROUP %in% c("1020",
                               "1028",
                               "2021",
                               "224",
                               "940"))

# Create interactive plotly boxplot
plot_ly(model_data_filtered, y = ~predicted_prob, x = ~VIC_AGE_GROUP, 
        color = ~VIC_AGE_GROUP, type = "box") %>%
  layout(title = "Predicted Probability of Murder by Victim Age Group",
         xaxis = list(title = "Victim Age Group"),
         yaxis = list(title = "Predicted Probability"),
         showlegend = FALSE)
```


In this visual we can see that as age increase, shootings are more leathal when the victim is older.

# Bias 

There are many opportunities for bias in this analysis, including data collection, feature selection, and model assumptions. It is important to further critically evaluate these factors to ensure that the conclusions drawn are valid and fair.

#### Data Collection Bias

This analysis did _not_ validate the methods of data collection or examine potential biases in how the data was gathered, which could affect the results.

#### Feature Selection Bias

The choice of features included in the model may show some correlation with the outcome but could be proxies for other underlying factors not included in the analysis.

#### Outliers

Outliers or missing data in the data could disproportionately influence the model's results, leading to misleading conclusions. A deeper examination of outliers and their impact on the analysis was not conducted.

#### Population Estimates
The population data used for per capita calculations were estimates and may not accurately reflect the true population during the years analyzed, potentially skewing the results.

---

# Conclusion

This analysis highlights disparities in gun violence between NYC neighborhoods and demonstrates how crisis events like the COVID-19 pandemic might exacerbate existing inequalities.

---


**Session Info**

```{r}
pander(sessionInfo())
```